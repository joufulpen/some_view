"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}var coolSti=function(){var a=function(a,b,c,d){var e=setInterval(function(){a(c)&&(clearInterval(e),b(c))},d?d:1)},b=function(){return localforage.setItemEx=function(a,b,c){return(localforage.length().then(function(a){return a>c})?localforage.clear():void 0).then(function(){return localforage.setItem(a,b)["catch"](function(c){if("QuotaExceededError"===c.name)return localforage.clear().then(function(){return localforage.setItem(a,b)});throw c})})}},c=function(a){var b=k+a;if(!Array.from(window.document.getElementsByTagName("link")).filter(function(a){return"prefetch"==a.rel}).some(function(a){return a.href.includes(b)})){var c=window.document.createElement("link");c.rel="prefetch",c.href=b,window.document.head.appendChild(c)}else j&&console.debug("\u65E0\u9700\u9884\u52A0\u8F7D ".concat(b))},d=function(b,c){return new Promise(function(d){var e=new Date().getTime(),f="".concat(k).concat(b,".").concat(c);if(!o[f]){o[f]="loading";var g=window.document.createElement("js"==c?"script":"link");"js"==c?g.src=f:(g.rel="stylesheet",g.href=f),g.onload=function(){j&&console.debug("\u5F02\u6B65\u52A0\u8F7D\u811A\u672C ".concat(f," \u8017\u65F6\uFF1A").concat(new Date().getTime()-e," \u6BEB\u79D2")),o[f]="loaded",d()},window.document.body.appendChild(g)}else a(function(a){var b=a.resources,c=a.path;return"loaded"==b[c]},function(a){var b=a.resolve;return b()},{resources:o,path:f,resolve:d})})},e=function(a){var b=a.token,c=a.url,e=a.report,f=a.template,g=a.data,h=a.variables;return d("stimulsoft/Scripts/stimulsoft.reports","js").then(function(){return c?d("axios.min","js").then(function(){return axios.defaults.baseURL=c,axios.defaults.headers.common["cool-token"]=b,axios.get("",{params:{report:e,template:f}})}):{data:void 0}}).then(function(a){var b=a.data;b&&b.rows&&(b=b.rows);var c=new Date().getTime(),d=new Stimulsoft.Report.StiReport;b?d.loadDocument(b):d.loadFile((e.includes("/")?"":k+"template/")+e+"/"+f+".mrt");var i=new Stimulsoft.System.Data.DataSet("\u9ED8\u8BA4\u6570\u636E\u6E90");for(var l in i.readJson(g),d.regData("\u9ED8\u8BA4\u6570\u636E\u6E90","\u9ED8\u8BA4\u6570\u636E\u6E90",i),h)d.setVariable(l,h[l]);return d.render(),j&&console.debug("\u521B\u5EFAreport \u8017\u65F6\uFF1A"+(new Date().getTime()-c)+" \u6BEB\u79D2"),d})},f=function(a){var b=a.url,c=a.onSaveReportName,e=a.onPrintReportName,f=a.id;return d("stimulsoft/Css/stimulsoft.viewer.office2013.whiteblue","css").then(function(){return d("stimulsoft/Scripts/stimulsoft.reports","js")}).then(function(){return d("stimulsoft/Scripts/stimulsoft.viewer","js")}).then(function(){Stimulsoft.Base.Localization.StiLocalization.setLocalizationFile(k+"stimulsoft/Localization/zh-CHS.xml",!1),Stimulsoft.Base.StiFontCollection.addOpentypeFontFile(k+"stimulsoft/fonts/msyh.ttf","\u5FAE\u8F6F\u96C5\u9ED1");var a=new Stimulsoft.Viewer.StiViewerOptions;a.height="100%",a.appearance.scrollbarsMode=!0,a.toolbar.showDesignButton=b||c,a.toolbar.printDestination=Stimulsoft.Viewer.StiPrintDestination.Pdf,a.appearance.htmlRenderMode=Stimulsoft.Report.Export.StiHtmlExportMode.Table,a.toolbar.showAboutButton=!1,a.exports.showExportToDocument=!1,a.exports.showExportToHtml=!1,a.exports.showExportToXml=!1,a.exports.showExportToXps=!1,a.exports.showExportToHtml5=!1;var h=new Stimulsoft.Viewer.StiViewer(a,"StiViewer",!1);return window.viewerInstance=h,h.onDesignReport=function(a){document.getElementById("loader").className="js_viewer_loader",h.visible=!1,document.getElementById("viewer").style.display="none";var e=b||c.includes("/")?function(a){d("axios.min","js").then(function(){return axios.post(b?"":c,{report:a.report.reportAlias,template:a.report.reportName,json:a.report.saveToJsonString()})}).then(function(){return alert("\u4FDD\u5B58\u6210\u529F")})["catch"](function(){return alert("\u4FDD\u5B58\u5931\u8D25")})}:function(a){return opener.postMessage({callback:c,args:JSON.stringify([{report:{reportName:a.report.reportName,reportAlias:a.report.reportAlias,jsonString:a.report.saveToJsonString()}}])},"*")};g(e).then(function(b){b.report=a.report,b.visible=!0,document.getElementById("designer").style.display="block",b.renderHtml("designer"),document.getElementById("loader").className=""})},h.onPrintReport=function(){return opener.postMessage({callback:e,args:JSON.stringify([f])},"*")},h})},g=function(a){return d("stimulsoft/Css/stimulsoft.designer.office2013.whiteblue","css").then(function(){return d("stimulsoft/Scripts/stimulsoft.reports","js")}).then(function(){return d("stimulsoft/Scripts/stimulsoft.designer","js")}).then(function(){Stimulsoft.Base.Localization.StiLocalization.setLocalizationFile(k+"stimulsoft/Localization/zh-CHS.xml",!1);var b=new Stimulsoft.Designer.StiDesignerOptions;b.toolbar.showFileMenuExit=!0,b.toolbar.showFileMenuOptions=!1,b.toolbar.showFileMenuAbout=!1,b.toolbar.showFileMenuClose=!1,b.toolbar.showFileMenuInfo=!1,b.toolbar.showFileMenuNew=!1,b.toolbar.showFileMenuSave=!1,b.appearance.fullScreenMode=!0,b.appearance.htmlRenderMode=Stimulsoft.Report.Export.StiHtmlExportMode.Table,b.appearance.showSaveDialog=!1,b.appearance.showTooltipsHelp=!1;var c=new Stimulsoft.Designer.StiDesigner(b,"StiDesigner",!1);return c.onExit=function(){c.visible=!1,document.getElementById("designer").style.display="none",window.viewerInstance.visible=!0,document.getElementById("viewer").style.display="block",document.title=window.pageTitle},c.onSaveReport=function(b){return a?a.call(window,b):alert("\u4E3B\u7A97\u53E3\u65B9\u6CD5\u5DF2\u4E0D\u53EF\u7528\r\n\u5982\u9700\u4F7F\u7528\u4E0D\u4F9D\u8D56\u4E3B\u7A97\u53E3\u7684\u4FDD\u5B58\u65B9\u6CD5\uFF0ConSaveReportName\u8BF7\u586B\u5165\u540E\u7AEF\u4FDD\u5B58\u7684\u5B8C\u6574URL")},c})},h=100,i={},j=!1,k="",l=void 0,m=void 0,n=Array.from(window.document.getElementsByTagName("link")).filter(function(a){return"preload"!==a.rel&&"prefetch"!==a.rel}).reduce(function(a,b){return a[b.href]="loaded",a},{}),o=Array.from(window.document.getElementsByTagName("script")).reduce(function(a,b){return a[b.src]="loaded",a},n),p=document.getElementsByTagName("script")[document.getElementsByTagName("script").length-1].getAttribute("src");k=p.substring(0,p.lastIndexOf("/")),0<k.length&&(k+="/"),0>k.indexOf("://")&&("/"===k.substr(0,1)?k=window.location.protocol+"//"+window.location.host+k:k=window.location.href.substring(0,window.location.href.lastIndexOf("/"))+"/"+k),c("localforage.min.js"),c("polyfill.min.js"),c("axios.min.js"),c("stimulsoft/Scripts/stimulsoft.reports.js"),c("stimulsoft/Scripts/stimulsoft.viewer.js"),c("stimulsoft/Scripts/stimulsoft.designer.js"),c("stimulsoft/Css/stimulsoft.viewer.office2013.whiteblue.css"),c("stimulsoft/Localization/zh-CHS.xml"),c("stimulsoft/fonts/msyh.ttf");var q=function getUrlParam(a){try{return window.location.search?window.location.search.substr(1).split("&").filter(function(a){return 1<a.split("=").length}).find(function(b){return b.split("=")[0]===a}).split("=")[1]:""}catch(a){return""}}("localforageId");return q?(window.addEventListener("load",function loadViewer(){return d("localforage.min","js").then(b).then(function(){var a;opener&&opener.postMessage({localforageId:q},"*");var b=0,c=setInterval(function(){100>b++&&!window.coolStiData||(clearInterval(c),j&&console.debug(b),a=window.coolStiData?JSON.parse(window.coolStiData):void 0,delete window.coolStiData,localforage.setItemEx(q,a?a:localforage.getItem(q),h).then(function(a){return document.title=a.pageTitle,window.pageTitle=a.pageTitle,l=a,e(a)}).then(function(a){return m=a,f(l)}).then(function(a){a.report=m,document.getElementById("loader").className="",l.isDirectEdit&&a.onDesignReport({report:a.report}),a.renderHtml("viewer")}))},1)})}),window.addEventListener("message",function(a){return window.coolStiData=a.data.coolStiData},!1)):window.addEventListener("message",function(a){a.data.localforageId&&a.source.postMessage({coolStiData:coolSti.localStorage[a.data.localforageId]},"*"),a.data.callback&&window[a.data.callback]&&window[a.data.callback].apply(a.source,JSON.parse(a.data.args))},!1),{get localStorage(){return i},view:function view(a,b,c,d,e,f,g,h,j){var l=Math.random().toString().substr(2);return new Promise(function(m){i[l]=JSON.stringify("object"==_typeof(a).toLowerCase()?a:{report:a,template:b,data:c,variables:d,onSaveReportName:e,pageTitle:f,isDirectEdit:g,onPrintReportName:h,id:j}),window.open(k+"cool-sti-viewer.html?localforageId="+l),m()})},print:function print(a,b,c,d){return e({report:a,template:b,data:c,variables:d}).then(function(a){return a.printToPdf()})},export:function _export(a,b,c,d,f,g){return e({report:c,template:d,data:f,variables:g}).then(function(c){return Object.saveAs(c.exportDocument(Stimulsoft.Report.StiExportFormat[b]),a)})},get debug(){return j},set debug(a){j=a},get localforageSize(){return h},set localforageSize(a){h=a}}}();